name: Deploy (Manual)

# Manual deployment workflow - use for hotfixes or re-deployments
# For normal releases, create a tag (v1.0.0) to trigger the Release workflow

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Image tag to deploy (e.g., v1.0.0 or latest)'
        required: false
        default: 'latest'

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Ansible
        run: |
          pip install ansible
          ansible-galaxy install -r ansible/requirements.yml
      
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/wealthpath_key
          chmod 600 ~/.ssh/wealthpath_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true
      
      - name: Run Ansible playbook
        working-directory: ansible
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          DOMAIN: ${{ secrets.DOMAIN }}
          USE_SSL: "true"
          USE_ZEROSSL: "true"
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ANSIBLE_HOST_KEY_CHECKING: "False"
          IMAGE_TAG: ${{ github.event.inputs.version }}
          # OAuth secrets
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          FACEBOOK_APP_ID: ${{ secrets.FACEBOOK_APP_ID }}
          FACEBOOK_APP_SECRET: ${{ secrets.FACEBOOK_APP_SECRET }}
          # AI
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # Admin Panel
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
        run: |
          echo "ðŸš€ Deploying version $IMAGE_TAG"
          ansible-playbook playbook.yml -v
      
      - name: Health check
        run: |
          sleep 10
          curl -sf https://${{ secrets.DOMAIN }}/api/health || echo "Health check pending..."

