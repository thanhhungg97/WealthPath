# WealthPath Caddy Configuration
#
# Environment variables:
#   DOMAIN    - Domain name (e.g., wealthpath.duckdns.org)
#   ACME_CA   - Optional: ACME CA URL for ZeroSSL
#   ACME_EMAIL - Optional: Email for certificate registration

{
    # Use ZeroSSL if ACME_CA is set
    acme_ca {$ACME_CA:}
    email {$ACME_EMAIL:}
}

# Main app - wealthpath.duckdns.org
{$DOMAIN:localhost} {
    # Admin panel routes (must be before frontend catch-all)
    @admin path /admin /admin/*
    reverse_proxy @admin admin:8081
    
    # Dozzle log viewer - Tailscale VPN only
    # Tailscale IPs: 100.64.0.0/10
    # Add your home IP if needed: e.g., 203.0.113.50
    @logs {
        path /logs /logs/*
        remote_ip 100.64.0.0/10
    }
    reverse_proxy @logs dozzle:8080
    
    # Block non-VPN access to /logs
    handle /logs* {
        respond "VPN Required" 403
    }
    
    # API routes to backend
    reverse_proxy /api/* backend:8080
    
    # Everything else to frontend
    reverse_proxy /* frontend:3000
    
    # Logging
    log {
        output stdout
        format console
    }
    
    # Security headers
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        Referrer-Policy strict-origin-when-cross-origin
        -Server
    }
    
    # Enable compression
    encode gzip zstd
}
