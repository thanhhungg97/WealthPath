---
# Deployment Tasks
# Pulls Docker images and starts services

- name: Pull Docker images
  community.docker.docker_compose_v2:
    project_src: "{{ app_dir }}"
    files:
      - "{{ compose_file }}"
    pull: always
    state: present
  # Run as root since ubuntu user needs re-login for docker group

- name: Stop existing services
  community.docker.docker_compose_v2:
    project_src: "{{ app_dir }}"
    files:
      - "{{ compose_file }}"
    state: absent
  ignore_errors: yes

- name: Start services
  community.docker.docker_compose_v2:
    project_src: "{{ app_dir }}"
    files:
      - "{{ compose_file }}"
    state: present
  register: compose_result

- name: List running containers
  shell: docker ps --format "table {{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}\t{{ '{{' }}.Ports{{ '}}' }}"
  register: docker_status
  changed_when: false

- name: Show container status
  debug:
    var: docker_status.stdout_lines

- name: Check admin container logs (if exists)
  shell: docker logs wealthpath-admin-1 --tail 20 2>&1 || echo "Admin container not found"
  register: admin_logs
  changed_when: false
  ignore_errors: yes

- name: Show admin logs
  debug:
    var: admin_logs.stdout_lines
  when: admin_logs.stdout != "Admin container not found"



