---
# WealthPath Deployment Playbook
# Usage: ansible-playbook -i inventory.yml playbook.yml

- name: Deploy WealthPath
  hosts: wealthpath
  become: yes
  
  vars:
    docker_compose_version: "2.24.0"
  
  tasks:
    # ============================================
    # System Setup
    # ============================================
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - git
          - jq
          - python3-pip
          - gnupg
          - lsb-release
        state: present

    # ============================================
    # Docker Installation
    # ============================================
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Start Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    # ============================================
    # Application Setup
    # ============================================
    - name: Create app directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Clone/update repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ app_dir }}"
        version: main
        force: yes
      become_user: ubuntu

    # ============================================
    # Get Server Info
    # ============================================
    - name: Get public IP
      uri:
        url: http://169.254.169.254/latest/meta-data/public-ipv4
        return_content: yes
      register: public_ip_result
      ignore_errors: yes

    - name: Set public IP fact
      set_fact:
        server_ip: "{{ public_ip_result.content | default(ansible_default_ipv4.address) }}"

    - name: Generate sslip.io domain
      set_fact:
        auto_domain: "{{ server_ip | replace('.', '-') }}.sslip.io"

    - name: Set final domain
      set_fact:
        final_domain: "{{ domain if domain != '' else auto_domain }}"
        protocol: "{{ 'https' if use_ssl == 'true' else 'http' }}"

    - name: Set ACME CA for ZeroSSL
      set_fact:
        acme_ca: "{{ 'https://acme.zerossl.com/v2/DV90' if (use_zerossl == 'true' and use_ssl == 'true') else '' }}"

    # ============================================
    # Environment Configuration
    # ============================================
    - name: Check if .env exists
      stat:
        path: "{{ app_dir }}/.env"
      register: env_file

    - name: Generate secrets
      set_fact:
        jwt_secret: "{{ lookup('password', '/dev/null length=64 chars=hexdigits') }}"
        postgres_password: "{{ lookup('password', '/dev/null length=32 chars=hexdigits') }}"
      when: not env_file.stat.exists

    - name: Read existing secrets
      slurp:
        src: "{{ app_dir }}/.env"
      register: existing_env
      when: env_file.stat.exists

    - name: Parse existing JWT secret
      set_fact:
        jwt_secret: "{{ existing_env.content | b64decode | regex_search('JWT_SECRET=(.+)', '\\1') | first }}"
      when: env_file.stat.exists and existing_env.content is defined
      ignore_errors: yes

    - name: Parse existing Postgres password
      set_fact:
        postgres_password: "{{ existing_env.content | b64decode | regex_search('POSTGRES_PASSWORD=(.+)', '\\1') | first }}"
      when: env_file.stat.exists and existing_env.content is defined
      ignore_errors: yes

    - name: Create .env file
      template:
        src: templates/env.j2
        dest: "{{ app_dir }}/.env"
        owner: ubuntu
        group: ubuntu
        mode: '0600'

    # ============================================
    # Deploy Application
    # ============================================
    - name: Pull Docker images
      community.docker.docker_compose_v2:
        project_src: "{{ app_dir }}"
        files:
          - "{{ compose_file }}"
        pull: always
        state: present
      become_user: ubuntu

    - name: Start services
      community.docker.docker_compose_v2:
        project_src: "{{ app_dir }}"
        files:
          - "{{ compose_file }}"
        state: present
      become_user: ubuntu
      register: compose_result

    # ============================================
    # Health Checks
    # ============================================
    - name: Wait for backend to be ready
      uri:
        url: "http://localhost:8080/api/health"
        status_code: 200
      register: backend_health
      retries: 30
      delay: 5
      until: backend_health.status == 200
      delegate_to: "{{ inventory_hostname }}"

    - name: Display deployment info
      debug:
        msg: |
          
          âœ… WealthPath deployed successfully!
          
          URL: {{ protocol }}://{{ final_domain }}
          IP:  {{ server_ip }}
          
          SSH: ssh -i ~/.ssh/wealthpath_key ubuntu@{{ server_ip }}

