---
# WealthPath Deployment Playbook
# Usage: ansible-playbook playbook.yml
# With vault: ansible-playbook playbook.yml --ask-vault-pass
#
# This playbook orchestrates the deployment by importing modular task files.
# Each task file handles a specific aspect of the deployment.

- name: Deploy WealthPath
  hosts: wealthpath
  become: yes
  
  vars:
    docker_compose_version: "2.24.0"
  
  pre_tasks:
    - name: Check if secrets.yml exists
      local_action: stat path=secrets.yml
      register: secrets_file
      become: no

    - name: Include secrets if available
      include_vars: secrets.yml
      when: secrets_file.stat.exists
      no_log: true

  tasks:
    # System setup - install base packages
    - name: System Setup
      import_tasks: tasks/system.yml

    # Docker installation and configuration
    - name: Docker Installation
      import_tasks: tasks/docker.yml

    # PostgreSQL installation and configuration
    - name: PostgreSQL Setup
      import_tasks: tasks/postgresql.yml

    # Application directory and repository
    - name: Application Setup
      import_tasks: tasks/app.yml

    # Configuration - domain, secrets, .env
    - name: Configuration
      import_tasks: tasks/config.yml

    # Docker Compose deployment
    - name: Deploy Application
      import_tasks: tasks/deploy.yml

    # Health checks and verification
    - name: Health Checks
      import_tasks: tasks/health.yml

  handlers:
    - name: restart postgresql
      systemd:
        name: postgresql
        state: restarted
